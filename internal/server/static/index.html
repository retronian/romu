<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>romu ‚Äî ROM Collection Manager</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--surface:#14141f;--border:#2a2a3a;--text:#e0e0e0;--dim:#888;--accent:#ff6b9d;--accent2:#c084fc;--green:#4ade80;--yellow:#fbbf24}
body{font-family:'Courier New',monospace;background:var(--bg);color:var(--text);min-height:100vh}
a{color:inherit;text-decoration:none}
.header{background:linear-gradient(135deg,#1a0a2e,#0a1628);border-bottom:2px solid var(--accent);padding:1.2rem 2rem;text-align:center;cursor:pointer}
.header h1{font-size:1.8rem;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.3em}
.header p{color:var(--dim);font-size:.75rem;margin-top:.2rem}
.container{max-width:1400px;margin:0 auto;padding:1.5rem;transition:margin-right .3s}
.container.panel-open{margin-right:420px}

/* Breadcrumb */
.breadcrumb{font-size:.8rem;color:var(--dim);margin-bottom:1rem}
.breadcrumb a{color:var(--accent);cursor:pointer}
.breadcrumb a:hover{text-decoration:underline}
.breadcrumb span{margin:0 .4rem}

/* Platform Grid */
.platform-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}
.platform-card{background:var(--surface);border:1px solid var(--border);cursor:pointer;transition:.2s;overflow:hidden;border-radius:6px}
.platform-card:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 8px 24px rgba(255,107,157,.15)}
.platform-icon{height:120px;display:flex;align-items:center;justify-content:center;font-size:3rem;position:relative;overflow:hidden}
.platform-icon .platform-bg{position:absolute;inset:0;opacity:.15}
.platform-icon .platform-emoji{position:relative;z-index:1;filter:drop-shadow(0 2px 8px rgba(0,0,0,.5))}
.platform-info{padding:1rem}
.platform-info .platform-name{font-size:1.1rem;font-weight:bold;color:var(--text)}
.platform-info .platform-full{font-size:.7rem;color:var(--dim);margin-top:.2rem}
.platform-info .platform-count{font-size:1.5rem;font-weight:bold;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:.3rem}
.platform-info .platform-sub{font-size:.65rem;color:var(--dim);margin-top:.2rem}
.platform-bar{height:3px;background:var(--border);margin-top:.6rem;border-radius:2px;overflow:hidden}
.platform-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px}

/* ROM Tile Grid */
.controls{display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center}
input{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:.5rem .8rem;font-family:inherit;font-size:.85rem;outline:none;flex:1;min-width:200px}
input:focus{border-color:var(--accent)}
.rom-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.8rem}
.rom-tile{background:var(--surface);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:.2s;overflow:hidden}
.rom-tile:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 16px rgba(255,107,157,.12)}
.rom-tile-img{width:100%;aspect-ratio:1/1;object-fit:cover;background:var(--bg);display:block}
.rom-tile-placeholder{width:100%;aspect-ratio:1/1;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:var(--border)}
.rom-tile-info{padding:.5rem .6rem}
.rom-tile-title{font-size:.75rem;font-weight:bold;color:var(--text);line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2em}
.rom-tile-sub{font-size:.6rem;color:var(--dim);margin-top:.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.pagination{display:flex;justify-content:center;align-items:center;gap:1rem;margin-top:1.2rem;color:var(--dim);font-size:.8rem}
.pagination button{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:.3rem .8rem;cursor:pointer;font-family:inherit;border-radius:4px}
.pagination button:disabled{opacity:.3;cursor:default}
.pagination button:hover:not(:disabled){border-color:var(--accent)}

/* Side Panel */
.side-panel{position:fixed;top:0;right:-420px;width:420px;height:100vh;background:var(--surface);border-left:2px solid var(--accent);overflow-y:auto;transition:right .3s ease;z-index:100}
.side-panel.open{right:0}
.panel-header{display:flex;justify-content:space-between;align-items:flex-start;padding:1.2rem 1.5rem;border-bottom:1px solid var(--border);background:linear-gradient(135deg,#1a0a2e,#0a1628)}
.panel-close{background:none;border:1px solid var(--border);color:var(--dim);font-size:1.2rem;cursor:pointer;padding:.2rem .6rem;font-family:inherit;transition:.2s}
.panel-close:hover{color:var(--accent);border-color:var(--accent)}
.panel-title-ja{font-size:1.3rem;color:var(--accent);font-weight:bold;line-height:1.4;word-break:break-word;white-space:normal}
.panel-title-en{font-size:.8rem;color:var(--dim);margin-top:.3rem;word-break:break-word;white-space:normal}
.panel-body{padding:1.2rem 1.5rem}
.panel-badge{display:inline-block;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:.2rem .6rem;font-size:.7rem;font-weight:bold;letter-spacing:.05em;margin-bottom:1rem;border-radius:2px}
.panel-section{margin-bottom:1.2rem}
.panel-section h4{color:var(--accent2);font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;margin-bottom:.5rem}
.panel-desc{color:var(--text);font-size:.85rem;line-height:1.7;white-space:pre-wrap;word-break:break-word}
.meta-table{width:100%;font-size:.8rem}
.meta-table td{padding:.35rem 0;border-bottom:1px solid rgba(42,42,58,.5);white-space:normal;max-width:none}
.meta-table td:first-child{color:var(--dim);width:80px;padding-right:.8rem;white-space:nowrap}
.meta-table td:last-child{color:var(--text)}
.panel-file-info{font-size:.75rem;color:var(--dim);line-height:1.8}
.panel-file-info code{color:var(--yellow);font-size:.75rem}
.panel-empty{color:var(--dim);font-style:italic;font-size:.85rem}

.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:99;display:none}
.overlay.open{display:block}

#platforms-view,#roms-view{display:none}
#platforms-view.active,#roms-view.active{display:block}

@media(max-width:600px){.container{padding:.8rem}.header h1{font-size:1.3rem}.side-panel{width:100%;right:-100%}.container.panel-open{margin-right:0}.platform-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}.rom-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}}
</style>
</head>
<body>
<div class="header" onclick="goHome()">
<h1>üéÆ ROMU</h1>
<p>ROM Collection Manager</p>
</div>
<div class="container" id="main-container">

<div id="platforms-view" class="active">
<div class="platform-grid" id="platform-grid"></div>
</div>

<div id="roms-view">
<div class="breadcrumb"><a onclick="goHome()">üè† „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</a><span>‚Ä∫</span><span id="crumb-platform"></span></div>
<div class="controls">
<input type="text" id="search" placeholder="üîç Ê§úÁ¥¢ („Çø„Ç§„Éà„É´ / „Éï„Ç°„Ç§„É´Âêç)..." oninput="debounceSearch()">
</div>
<div class="rom-grid" id="rom-grid"></div>
<div class="pagination">
<button id="prev-btn" onclick="changePage(-1)">‚óÄ Prev</button>
<span id="page-info"></span>
<button id="next-btn" onclick="changePage(1)">Next ‚ñ∂</button>
</div>
</div>

</div>

<div class="overlay" id="panel-overlay" onclick="closePanel()"></div>
<div class="side-panel" id="side-panel">
<div class="panel-header">
<div>
<div class="panel-title-ja" id="panel-title-ja"></div>
<div class="panel-title-en" id="panel-title-en"></div>
</div>
<button class="panel-close" onclick="closePanel()">‚úï</button>
</div>
<div class="panel-body" id="panel-body"></div>
</div>

<script>
let page=1,perPage=120,searchTimer,currentRoms=[],currentPlatform='';

const PLATFORMS={
  FC:  {name:'Famicom / NES',       emoji:'üéÆ', color:['#c0392b','#e74c3c']},
  SFC: {name:'Super Famicom / SNES', emoji:'üéÆ', color:['#8e44ad','#9b59b6']},
  GB:  {name:'Game Boy',             emoji:'üü¢', color:['#27ae60','#2ecc71']},
  GBC: {name:'Game Boy Color',       emoji:'üíú', color:['#8e44ad','#a855f7']},
  GBA: {name:'Game Boy Advance',     emoji:'üîµ', color:['#2980b9','#3498db']},
  N64: {name:'Nintendo 64',          emoji:'üïπÔ∏è', color:['#d35400','#e67e22']},
  NDS: {name:'Nintendo DS',          emoji:'üì±', color:['#7f8c8d','#95a5a6']},
  MD:  {name:'Mega Drive / Genesis', emoji:'‚ö°', color:['#2c3e50','#34495e']},
  SMS: {name:'Master System',        emoji:'üî¥', color:['#c0392b','#e74c3c']},
  GG:  {name:'Game Gear',            emoji:'üñ•Ô∏è', color:['#2c3e50','#34495e']},
  PCE: {name:'PC Engine',            emoji:'üü†', color:['#d35400','#e67e22']},
  NGP: {name:'Neo Geo Pocket',       emoji:'üéØ', color:['#f39c12','#f1c40f']},
  WS:  {name:'WonderSwan',           emoji:'‚ú®', color:['#1abc9c','#16a085']},
  WSC: {name:'WonderSwan Color',     emoji:'üåà', color:['#e91e63','#ff5722']},
  MAME:{name:'Arcade (MAME)',        emoji:'üïπÔ∏è', color:['#ff6b9d','#c084fc']},
  FBN: {name:'Arcade (FBNeo)',       emoji:'üëæ', color:['#ff6b9d','#c084fc']},
  ARCADE:{name:'Arcade',             emoji:'üïπÔ∏è', color:['#ff6b9d','#c084fc']}
};

function goHome(){
  currentPlatform='';
  document.getElementById('platforms-view').classList.add('active');
  document.getElementById('roms-view').classList.remove('active');
  closePanel();
  loadPlatformGrid();
}

function selectPlatform(p){
  currentPlatform=p;
  page=1;
  document.getElementById('search').value='';
  document.getElementById('platforms-view').classList.remove('active');
  document.getElementById('roms-view').classList.add('active');
  const info=PLATFORMS[p.toUpperCase()]||{name:p};
  document.getElementById('crumb-platform').textContent=info.name+' ('+p+')';
  loadRoms();
}

async function loadPlatformGrid(){
  const r=await fetch('/api/stats');
  const d=await r.json();
  const platforms=d.platforms||[];
  const grid=document.getElementById('platform-grid');
  grid.innerHTML=platforms.map(p=>{
    const info=PLATFORMS[p.platform.toUpperCase()]||{name:p.platform,emoji:'üéÆ',color:['#333','#555']};
    const pct=p.total?Math.round(p.matched/p.total*100):0;
    const [c1,c2]=info.color||['#333','#555'];
    return `<div class="platform-card" onclick="selectPlatform('${p.platform}')">
      <div class="platform-icon">
        <div class="platform-bg" style="background:linear-gradient(135deg,${c1},${c2})"></div>
        <div class="platform-emoji">${info.emoji}</div>
      </div>
      <div class="platform-info">
        <div class="platform-name">${escHtml(p.platform)}</div>
        <div class="platform-full">${escHtml(info.name)}</div>
        <div class="platform-count">${p.total} <span style="font-size:.6rem;color:var(--dim)">ROMs</span></div>
        <div class="platform-sub">${p.matched} matched ¬∑ ${pct}% enriched</div>
        <div class="platform-bar"><div class="platform-bar-fill" style="width:${pct}%"></div></div>
      </div>
    </div>`;
  }).join('');
}

function debounceSearch(){clearTimeout(searchTimer);searchTimer=setTimeout(()=>{page=1;loadRoms()},300)}
function changePage(d){page+=d;loadRoms();window.scrollTo(0,0)}
function fmt(n){if(n>=1e9)return(n/1e9).toFixed(1)+'G';if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n}

function openPanel(rom){
  const p=document.getElementById('side-panel');
  const o=document.getElementById('panel-overlay');
  const titleJA=rom.title_ja||rom.title||'-';
  const titleEN=rom.title_en||'';
  document.getElementById('panel-title-ja').textContent=titleJA;
  document.getElementById('panel-title-en').textContent=titleEN;

  let html='';
  if(rom.title_en){
    const coverUrl='/covers/'+encodeURIComponent(rom.platform)+'/'+encodeURIComponent(rom.title_en.replace(/[\/\\:*?"<>|]/g,'_'))+'.png';
    html+=`<div style="text-align:center;margin-bottom:1rem"><img src="${coverUrl}" style="max-width:300px;width:100%;border-radius:8px" onerror="this.parentElement.style.display='none'"></div>`;
  }

  html+=`<span class="panel-badge">${rom.platform}</span>`;

  if(rom.desc_ja){
    html+=`<div class="panel-section"><h4>Ë™¨Êòé</h4><div class="panel-desc">${escHtml(rom.desc_ja)}</div></div>`;
  }

  const meta=[
    ['ÈñãÁô∫ÂÖÉ',rom.developer],['Áô∫Â£≤ÂÖÉ',rom.publisher],['Áô∫Â£≤Êó•',formatDate(rom.release_date)],
    ['„Ç∏„É£„É≥„É´',rom.genre],['„Éó„É¨„Ç§„É§„Éº',rom.players],['Ë©ï‰æ°',rom.rating]
  ].filter(m=>m[1]);
  if(meta.length){
    html+=`<div class="panel-section"><h4>„É°„Çø„Éá„Éº„Çø</h4><table class="meta-table">`;
    meta.forEach(m=>{html+=`<tr><td>${m[0]}</td><td>${escHtml(m[1])}</td></tr>`});
    html+=`</table></div>`;
  }

  html+=`<div class="panel-section"><h4>„Éï„Ç°„Ç§„É´ÊÉÖÂ†±</h4><div class="panel-file-info">`;
  html+=`„Éï„Ç°„Ç§„É´Âêç: <code>${escHtml(rom.filename)}</code><br>`;
  html+=`„Çµ„Ç§„Ç∫: <code>${fmt(rom.size)}</code><br>`;
  html+=`CRC32: <code>${escHtml(rom.crc32)}</code>`;
  html+=`</div></div>`;

  if(!rom.desc_ja&&!meta.length){
    html+=`<div class="panel-empty">„É°„Çø„Éá„Éº„Çø„Å™„Åó</div>`;
  }

  document.getElementById('panel-body').innerHTML=html;
  p.classList.add('open');
  o.classList.add('open');
  document.getElementById('main-container').classList.add('panel-open');
}

function closePanel(){
  document.getElementById('side-panel').classList.remove('open');
  document.getElementById('panel-overlay').classList.remove('open');
  document.getElementById('main-container').classList.remove('panel-open');
}

function formatDate(s){if(!s)return null;const m=s.match(/^(\d{4})(\d{2})(\d{2})/);if(m)return m[1]+'Âπ¥'+m[2]+'Êúà'+m[3]+'Êó•';return s}
function escHtml(s){if(!s)return'';return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function coverUrl(rom){
  if(!rom.title_en)return'';
  return'/covers/'+encodeURIComponent(rom.platform)+'/'+encodeURIComponent(rom.title_en.replace(/[\/\\:*?"<>|]/g,'_'))+'.png';
}

async function loadRoms(){
  const q=document.getElementById('search').value;
  const r=await fetch(`/api/roms?q=${encodeURIComponent(q)}&platform=${encodeURIComponent(currentPlatform)}&page=${page}&per_page=${perPage}`);
  const d=await r.json();
  currentRoms=d.roms||[];
  const g=document.getElementById('rom-grid');
  g.innerHTML=currentRoms.map((r,i)=>{
    const titleJA=r.title_ja||r.title||r.filename;
    const sub=r.title_en||r.filename;
    const url=coverUrl(r);
    const img=url
      ?`<img class="rom-tile-img" src="${url}" onerror="this.outerHTML='<div class=\\'rom-tile-placeholder\\'>üéÆ</div>'" loading="lazy">`
      :`<div class="rom-tile-placeholder">üéÆ</div>`;
    return `<div class="rom-tile" onclick="openPanel(currentRoms[${i}])">
      ${img}
      <div class="rom-tile-info">
        <div class="rom-tile-title">${escHtml(titleJA)}</div>
        <div class="rom-tile-sub">${escHtml(sub)}</div>
      </div>
    </div>`;
  }).join('');
  const tp=Math.ceil(d.total/perPage)||1;
  document.getElementById('page-info').textContent=`${page} / ${tp} (${d.total} ROMs)`;
  document.getElementById('prev-btn').disabled=page<=1;
  document.getElementById('next-btn').disabled=page>=tp;
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closePanel()});
loadPlatformGrid();
</script>
</body>
</html>
