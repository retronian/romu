<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>romu ‚Äî ROM Collection Manager</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--surface:#14141f;--border:#2a2a3a;--text:#e0e0e0;--dim:#888;--accent:#ff6b9d;--accent2:#c084fc;--green:#4ade80;--yellow:#fbbf24}
body{font-family:'Courier New',monospace;background:var(--bg);color:var(--text);min-height:100vh}
a{color:inherit;text-decoration:none}
.header{background:linear-gradient(135deg,#1a0a2e,#0a1628);border-bottom:2px solid var(--accent);padding:1.5rem 2rem;text-align:center;cursor:pointer}
.header h1{font-size:2rem;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.3em}
.header p{color:var(--dim);font-size:.8rem;margin-top:.3rem}
.container{max-width:1200px;margin:0 auto;padding:1.5rem;transition:margin-right .3s}
.container.panel-open{margin-right:420px}

/* Breadcrumb */
.breadcrumb{font-size:.8rem;color:var(--dim);margin-bottom:1.2rem}
.breadcrumb a{color:var(--accent);cursor:pointer}
.breadcrumb a:hover{text-decoration:underline}
.breadcrumb span{margin:0 .4rem}

/* Platform Grid */
.platform-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem}
.platform-card{background:var(--surface);border:1px solid var(--border);padding:1.5rem;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.platform-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.platform-card .platform-name{font-size:1.3rem;font-weight:bold;color:var(--text);margin-bottom:.5rem}
.platform-card .platform-count{font-size:2rem;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:bold}
.platform-card .platform-sub{color:var(--dim);font-size:.75rem;margin-top:.3rem}
.platform-card .platform-bar{height:3px;background:var(--border);margin-top:.8rem;border-radius:2px;overflow:hidden}
.platform-card .platform-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px}

/* ROM list */
.controls{display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}
input,select{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:.5rem .8rem;font-family:inherit;font-size:.85rem;outline:none}
input:focus,select:focus{border-color:var(--accent)}
input{flex:1;min-width:200px}
table{width:100%;border-collapse:collapse}
th,td{padding:.5rem .8rem;text-align:left;border-bottom:1px solid var(--border);font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:400px}
th{color:var(--accent);text-transform:uppercase;font-size:.7rem;letter-spacing:.1em}
tr.rom-row{cursor:pointer;transition:background .15s}
tr.rom-row:hover td{background:rgba(255,107,157,.08)}
tr.rom-row.selected td{background:rgba(255,107,157,.15)}
.rom-thumb{width:40px;height:40px;object-fit:cover;border-radius:4px;vertical-align:middle;background:var(--bg)}
.rom-thumb-placeholder{width:40px;height:40px;background:var(--bg);border:1px solid var(--border);border-radius:4px;display:inline-flex;align-items:center;justify-content:center;color:var(--dim);font-size:1rem}
td.td-title{white-space:normal;max-width:none}
.title-main{font-size:.95rem;font-weight:bold;color:var(--text);line-height:1.4}
.title-sub{font-size:.75rem;color:var(--dim);line-height:1.3;margin-top:.1rem}
td.td-thumb{width:50px;padding:.3rem .5rem}
.pagination{display:flex;justify-content:center;align-items:center;gap:1rem;margin-top:1rem;color:var(--dim);font-size:.8rem}
.pagination button{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:.3rem .8rem;cursor:pointer;font-family:inherit}
.pagination button:disabled{opacity:.3;cursor:default}
.pagination button:hover:not(:disabled){border-color:var(--accent)}

/* Side Panel */
.side-panel{position:fixed;top:0;right:-420px;width:420px;height:100vh;background:var(--surface);border-left:2px solid var(--accent);overflow-y:auto;transition:right .3s ease;z-index:100}
.side-panel.open{right:0}
.panel-header{display:flex;justify-content:space-between;align-items:flex-start;padding:1.2rem 1.5rem;border-bottom:1px solid var(--border);background:linear-gradient(135deg,#1a0a2e,#0a1628)}
.panel-close{background:none;border:1px solid var(--border);color:var(--dim);font-size:1.2rem;cursor:pointer;padding:.2rem .6rem;font-family:inherit;transition:.2s}
.panel-close:hover{color:var(--accent);border-color:var(--accent)}
.panel-title-ja{font-size:1.3rem;color:var(--accent);font-weight:bold;line-height:1.4;word-break:break-word;white-space:normal}
.panel-title-en{font-size:.8rem;color:var(--dim);margin-top:.3rem;word-break:break-word;white-space:normal}
.panel-body{padding:1.2rem 1.5rem}
.panel-badge{display:inline-block;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:.2rem .6rem;font-size:.7rem;font-weight:bold;letter-spacing:.05em;margin-bottom:1rem;border-radius:2px}
.panel-section{margin-bottom:1.2rem}
.panel-section h4{color:var(--accent2);font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;margin-bottom:.5rem}
.panel-desc{color:var(--text);font-size:.85rem;line-height:1.7;white-space:pre-wrap;word-break:break-word}
.meta-table{width:100%;font-size:.8rem}
.meta-table td{padding:.35rem 0;border-bottom:1px solid rgba(42,42,58,.5);white-space:normal;max-width:none}
.meta-table td:first-child{color:var(--dim);width:80px;padding-right:.8rem;white-space:nowrap}
.meta-table td:last-child{color:var(--text)}
.panel-file-info{font-size:.75rem;color:var(--dim);line-height:1.8}
.panel-file-info code{color:var(--yellow);font-size:.75rem}
.panel-empty{color:var(--dim);font-style:italic;font-size:.85rem}

.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:99;display:none}
.overlay.open{display:block}

#platforms-view,#roms-view{display:none}
#platforms-view.active,#roms-view.active{display:block}

@media(max-width:600px){.container{padding:.8rem}th,td{padding:.3rem .4rem;font-size:.7rem}.header h1{font-size:1.3rem}.side-panel{width:100%;right:-100%}.container.panel-open{margin-right:0}.platform-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}}
</style>
</head>
<body>
<div class="header" onclick="goHome()">
<h1>üéÆ ROMU</h1>
<p>ROM Collection Manager</p>
</div>
<div class="container" id="main-container">

<div id="platforms-view" class="active">
<div class="platform-grid" id="platform-grid"></div>
</div>

<div id="roms-view">
<div class="breadcrumb"><a onclick="goHome()">üè† „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</a><span>‚Ä∫</span><span id="crumb-platform"></span></div>
<div class="controls">
<input type="text" id="search" placeholder="üîç Ê§úÁ¥¢ („Çø„Ç§„Éà„É´ / „Éï„Ç°„Ç§„É´Âêç)..." oninput="debounceSearch()">
</div>
<table><thead><tr><th></th><th>„Çø„Ç§„Éà„É´</th><th>Size</th></tr></thead><tbody id="rom-body"></tbody></table>
<div class="pagination">
<button id="prev-btn" onclick="changePage(-1)">‚óÄ Prev</button>
<span id="page-info"></span>
<button id="next-btn" onclick="changePage(1)">Next ‚ñ∂</button>
</div>
</div>

</div>

<div class="overlay" id="panel-overlay" onclick="closePanel()"></div>
<div class="side-panel" id="side-panel">
<div class="panel-header">
<div>
<div class="panel-title-ja" id="panel-title-ja"></div>
<div class="panel-title-en" id="panel-title-en"></div>
</div>
<button class="panel-close" onclick="closePanel()">‚úï</button>
</div>
<div class="panel-body" id="panel-body"></div>
</div>

<script>
let page=1,perPage=50,searchTimer,currentRoms=[],currentPlatform='',platformStats=[];

const PLATFORM_NAMES={
  FC:'Famicom / NES',SFC:'Super Famicom / SNES',GB:'Game Boy',GBC:'Game Boy Color',
  GBA:'Game Boy Advance',N64:'Nintendo 64',NDS:'Nintendo DS',MD:'Mega Drive / Genesis',
  SMS:'Master System',GG:'Game Gear',PCE:'PC Engine',NGP:'Neo Geo Pocket',
  WS:'WonderSwan',WSC:'WonderSwan Color',MAME:'Arcade (MAME)',FBN:'Arcade (FBNeo)',
  PS1:'PlayStation',PSP:'PSP',ARCADE:'Arcade'
};

const PLATFORM_EMOJI={
  FC:'üéÆ',SFC:'üéÆ',GB:'üì±',GBC:'üì±',GBA:'üì±',N64:'üïπÔ∏è',NDS:'üì±',
  MD:'üéÆ',SMS:'üéÆ',GG:'üì±',PCE:'üéÆ',NGP:'üì±',WS:'üì±',WSC:'üì±',
  MAME:'üïπÔ∏è',FBN:'üïπÔ∏è',PS1:'üíø',PSP:'üì±',ARCADE:'üïπÔ∏è'
};

function goHome(){
  currentPlatform='';
  document.getElementById('platforms-view').classList.add('active');
  document.getElementById('roms-view').classList.remove('active');
  closePanel();
  loadPlatformGrid();
}

function selectPlatform(p){
  currentPlatform=p;
  page=1;
  document.getElementById('search').value='';
  document.getElementById('platforms-view').classList.remove('active');
  document.getElementById('roms-view').classList.add('active');
  document.getElementById('crumb-platform').textContent=(PLATFORM_NAMES[p.toUpperCase()]||p)+' ('+p+')';
  loadRoms();
}

async function loadPlatformGrid(){
  const r=await fetch('/api/stats');
  const d=await r.json();
  platformStats=d.platforms||[];
  const grid=document.getElementById('platform-grid');
  const mx=Math.max(...platformStats.map(p=>p.total),1);
  grid.innerHTML=platformStats.map(p=>{
    const name=PLATFORM_NAMES[p.platform.toUpperCase()]||p.platform;
    const emoji=PLATFORM_EMOJI[p.platform.toUpperCase()]||'üéÆ';
    const pct=p.total?Math.round(p.matched/p.total*100):0;
    return `<div class="platform-card" onclick="selectPlatform('${p.platform}')">
      <div class="platform-name">${emoji} ${escHtml(p.platform)}</div>
      <div class="platform-count">${p.total}</div>
      <div class="platform-sub">${escHtml(name)} ‚Äî ${pct}% enriched</div>
      <div class="platform-bar"><div class="platform-bar-fill" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
}

function debounceSearch(){clearTimeout(searchTimer);searchTimer=setTimeout(()=>{page=1;loadRoms()},300)}
function changePage(d){page+=d;loadRoms()}
function fmt(n){if(n>=1e9)return(n/1e9).toFixed(1)+'G';if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n}

function openPanel(rom){
  const p=document.getElementById('side-panel');
  const o=document.getElementById('panel-overlay');
  const titleJA=rom.title_ja||rom.title||'-';
  const titleEN=rom.title_en||'';
  document.getElementById('panel-title-ja').textContent=titleJA;
  document.getElementById('panel-title-en').textContent=titleEN;

  let html='';
  if(rom.title_en){
    const coverUrl='/covers/'+encodeURIComponent(rom.platform)+'/'+encodeURIComponent(rom.title_en.replace(/[\/\\:*?"<>|]/g,'_'))+'.png';
    html+=`<div style="text-align:center;margin-bottom:1rem"><img src="${coverUrl}" style="max-width:300px;width:100%;border-radius:8px" onerror="this.parentElement.style.display='none'"></div>`;
  }

  html+=`<span class="panel-badge">${rom.platform}</span>`;

  if(rom.desc_ja){
    html+=`<div class="panel-section"><h4>Ë™¨Êòé</h4><div class="panel-desc">${escHtml(rom.desc_ja)}</div></div>`;
  }

  const meta=[
    ['ÈñãÁô∫ÂÖÉ',rom.developer],['Áô∫Â£≤ÂÖÉ',rom.publisher],['Áô∫Â£≤Êó•',formatDate(rom.release_date)],
    ['„Ç∏„É£„É≥„É´',rom.genre],['„Éó„É¨„Ç§„É§„Éº',rom.players],['Ë©ï‰æ°',rom.rating]
  ].filter(m=>m[1]);
  if(meta.length){
    html+=`<div class="panel-section"><h4>„É°„Çø„Éá„Éº„Çø</h4><table class="meta-table">`;
    meta.forEach(m=>{html+=`<tr><td>${m[0]}</td><td>${escHtml(m[1])}</td></tr>`});
    html+=`</table></div>`;
  }

  html+=`<div class="panel-section"><h4>„Éï„Ç°„Ç§„É´ÊÉÖÂ†±</h4><div class="panel-file-info">`;
  html+=`„Éï„Ç°„Ç§„É´Âêç: <code>${escHtml(rom.filename)}</code><br>`;
  html+=`„Çµ„Ç§„Ç∫: <code>${fmt(rom.size)}</code><br>`;
  html+=`CRC32: <code>${escHtml(rom.crc32)}</code>`;
  html+=`</div></div>`;

  if(!rom.desc_ja&&!meta.length){
    html+=`<div class="panel-empty">„É°„Çø„Éá„Éº„Çø„Å™„Åó</div>`;
  }

  document.getElementById('panel-body').innerHTML=html;
  p.classList.add('open');
  o.classList.add('open');
  document.getElementById('main-container').classList.add('panel-open');

  document.querySelectorAll('.rom-row').forEach(r=>r.classList.remove('selected'));
  const sel=document.querySelector(`[data-idx="${currentRoms.indexOf(rom)}"]`);
  if(sel)sel.classList.add('selected');
}

function closePanel(){
  document.getElementById('side-panel').classList.remove('open');
  document.getElementById('panel-overlay').classList.remove('open');
  document.getElementById('main-container').classList.remove('panel-open');
  document.querySelectorAll('.rom-row').forEach(r=>r.classList.remove('selected'));
}

function formatDate(s){if(!s)return null;const m=s.match(/^(\d{4})(\d{2})(\d{2})/);if(m)return m[1]+'Âπ¥'+m[2]+'Êúà'+m[3]+'Êó•';return s}
function escHtml(s){if(!s)return'';return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

async function loadRoms(){
  const q=document.getElementById('search').value;
  const r=await fetch(`/api/roms?q=${encodeURIComponent(q)}&platform=${encodeURIComponent(currentPlatform)}&page=${page}&per_page=${perPage}`);
  const d=await r.json();
  currentRoms=d.roms||[];
  const b=document.getElementById('rom-body');
  b.innerHTML=currentRoms.map((r,i)=>{
    const titleJA=r.title_ja||r.title||r.filename;
    const titleEN=r.title_en||'';
    const sub=titleEN&&titleEN!==titleJA?titleEN:r.filename;
    const subLine=sub?`<div class="title-sub">${escHtml(sub)}</div>`:'';
    let thumb='<div class="rom-thumb-placeholder">üéÆ</div>';
    if(r.title_en){
      const coverUrl='/covers/'+encodeURIComponent(r.platform)+'/'+encodeURIComponent(r.title_en.replace(/[\/\\:*?"<>|]/g,'_'))+'.png';
      thumb=`<img class="rom-thumb" src="${coverUrl}" onerror="this.outerHTML='<div class=\\'rom-thumb-placeholder\\'>üéÆ</div>'">`;
    }
    return `<tr class="rom-row" data-idx="${i}" onclick="openPanel(currentRoms[${i}])"><td class="td-thumb">${thumb}</td><td class="td-title"><div class="title-main">${escHtml(titleJA)}</div>${subLine}</td><td>${fmt(r.size)}</td></tr>`;
  }).join('');
  const tp=Math.ceil(d.total/perPage)||1;
  document.getElementById('page-info').textContent=`${page} / ${tp} (${d.total} ROMs)`;
  document.getElementById('prev-btn').disabled=page<=1;
  document.getElementById('next-btn').disabled=page>=tp;
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closePanel()});
loadPlatformGrid();
</script>
</body>
</html>
